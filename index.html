<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карта рекламных щитов</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #wrap { display: grid; grid-template-columns: 1fr 380px; height: 100vh; }
    #map { height: 100vh; }
    #panel { border-left: 1px solid #e6e6e6; padding: 14px; overflow: auto; }
    .hint { font-size: 13px; color: #555; line-height: 1.35; }
    .chip { display: inline-block; padding: 6px 10px; border: 1px solid #ddd; border-radius: 999px; margin: 6px 6px 0 0; font-size: 13px; }
    .btn { cursor: pointer; border: 1px solid #ddd; background: #fff; padding: 10px 12px; border-radius: 10px; }
    .btn:hover { background: #fafafa; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .sep { height: 1px; background: #eee; margin: 12px 0; }

    /* popup images */
    .popup-img {
      width: 100%;
      max-width: 260px;
      height: auto;
      display: block;
      border-radius: 10px;
      margin: 8px 0 0;
      border: 1px solid #eee;
    }
    .popup-title { font-weight: 650; }
    .popup-meta { font-size: 12px; color: #666; margin-top: 2px; }
  </style>
</head>

<body>
  <div id="wrap">
    <div id="map"></div>

    <div id="panel">
      <div style="font-weight:700; font-size:18px;">Заявка</div>
      <div class="hint" style="margin-top:6px;">
        Кликайте по маркерам на карте — выбранные <b>ID</b> добавятся в форму автоматически.
        Повторный клик по выбранному ID — снимает выбор.
      </div>

      <div class="sep"></div>

      <div style="font-weight:650;">Выбрано ID:</div>
      <div id="selectedChips" style="margin-top:6px;"></div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="clearBtn" type="button">Очистить выбор</button>
        <button class="btn" id="copyBtn" type="button">Скопировать ID</button>
      </div>

      <div class="sep"></div>

      <!-- ✅ Вариант 1: твоя собственная HTML-форма, которая постит прямо в Pipedrive -->
      <!-- Подставь action и name hidden-поля из кода Pipedrive -->
      <form id="leadForm" method="post" action="__PIPEDRIVE_FORM_ACTION__">
        <!-- Только ID. Остальные поля можешь удалить/оставить — как тебе нужно -->
        <input type="hidden" id="billboardIds" name="__PIPEDRIVE_ID_FIELD_NAME__" value="">

        <div style="display:grid; gap:10px;">
          <label>
            Имя<br/>
            <input name="name" required style="width:100%; padding:10px; border:1px solid #ddd; border-radius:10px;">
          </label>

          <label>
            Телефон<br/>
            <input name="phone" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:10px;">
          </label>

          <label>
            Email<br/>
            <input name="email" type="email" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:10px;">
          </label>

          <button class="btn" type="submit" style="padding:12px 14px; border-radius:12px;">
            Отправить
          </button>

          <div class="hint">
            Hidden поле (только ID): <code id="debugHidden"></code>
          </div>
        </div>
      </form>

      <!-- ✅ Вариант 2 (если у тебя iframe-форма Pipedrive):
           Тогда вместо form выше — вставь iframe, а hidden field обновлять нельзя напрямую.
           В таком случае лучше использовать Вариант 1 (post в Pipedrive).
      -->
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    /***********************
     * 1) НАСТРОЙКИ
     ***********************/
    const SHEET_ID = "__GOOGLE_SHEET_ID__";
    const SHEET_NAME = "__SHEET_TAB_NAME__"; // например "Sheet1"
    // Ожидаемые заголовки колонок в таблице:
    // ID | Lat | Lng | Photo
    const COL_ID = "ID";
    const COL_LAT = "Lat";
    const COL_LNG = "Lng";
    const COL_PHOTO = "Photo"; // URL фото или несколько URL через запятую/пробел/перенос строки

    // Pipedrive:
    const PIPEDRIVE_FORM_ACTION = "__PIPEDRIVE_FORM_ACTION__";
    const PIPEDRIVE_ID_FIELD_NAME = "__PIPEDRIVE_ID_FIELD_NAME__";

    // применим в DOM
    document.querySelector("#leadForm").action = PIPEDRIVE_FORM_ACTION;
    document.querySelector("#billboardIds").name = PIPEDRIVE_ID_FIELD_NAME;

    /***********************
     * 2) ВСПОМОГАТЕЛЬНЫЕ
     ***********************/
    function esc(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function parsePhotoUrls(cell) {
      const raw = String(cell ?? "").trim();
      if (!raw) return [];
      // поддержим: запятые, пробелы, переносы строк, точки с запятой
      const parts = raw
        .split(/[\n,;]+/g)
        .map(s => s.trim())
        .filter(Boolean);

      // если кто-то разделял пробелами — добьём:
      const urls = [];
      for (const p of parts) {
        if (p.includes("http")) {
          // иногда "url1 url2"
          const maybe = p.split(/\s+/g).map(x => x.trim()).filter(Boolean);
          urls.push(...maybe);
        }
      }
      // уберём мусор и дубликаты
      return [...new Set(urls)].filter(u => /^https?:\/\//i.test(u));
    }

    function toNumber(x) {
      const n = Number(String(x).replace(",", "."));
      return Number.isFinite(n) ? n : null;
    }

    /***********************
     * 3) ЛОГИКА ВЫБОРА ID
     ***********************/
    const selectedIds = new Set();

    function syncSelectedUI() {
      // hidden value: "12,18,44"
      const ids = [...selectedIds];
      const value = ids.join(",");
      const hidden = document.getElementById("billboardIds");
      hidden.value = value;
      document.getElementById("debugHidden").textContent = value;

      // chips
      const chips = document.getElementById("selectedChips");
      chips.innerHTML = "";
      if (ids.length === 0) {
        chips.innerHTML = `<div class="hint">Пока ничего не выбрано.</div>`;
        return;
      }
      for (const id of ids) {
        const el = document.createElement("span");
        el.className = "chip";
        el.textContent = id;
        el.title = "Нажмите, чтобы убрать";
        el.onclick = () => {
          selectedIds.delete(id);
          syncSelectedUI();
        };
        chips.appendChild(el);
      }
    }

    function toggleId(id) {
      if (!id) return;
      if (selectedIds.has(id)) selectedIds.delete(id);
      else selectedIds.add(id);
      syncSelectedUI();
    }

    document.getElementById("clearBtn").addEventListener("click", () => {
      selectedIds.clear();
      syncSelectedUI();
    });

    document.getElementById("copyBtn").addEventListener("click", async () => {
      const value = [...selectedIds].join(",");
      try {
        await navigator.clipboard.writeText(value);
      } catch {
        // fallback
        const ta = document.createElement("textarea");
        ta.value = value;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      }
    });

    syncSelectedUI();

    /***********************
     * 4) КАРТА
     ***********************/
    const map = L.map("map", { preferCanvas: true }).setView([50.584, 8.678], 11); // старт (пример: Гиссен)
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const markersLayer = L.layerGroup().addTo(map);

    /***********************
     * 5) ЗАГРУЗКА ДАННЫХ ИЗ GOOGLE SHEETS (GVIZ JSON)
     ***********************/
    async function loadSheetRows() {
      // GViz endpoint (не требует API key, если лист опубликован)
      const url =
        `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SHEET_ID)}/gviz/tq?` +
        `tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

      const res = await fetch(url);
      if (!res.ok) throw new Error("Не удалось загрузить таблицу: " + res.status);
      const text = await res.text();

      // Google возвращает "google.visualization.Query.setResponse(...);"
      const jsonText = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
      const data = JSON.parse(jsonText);

      const cols = data.table.cols.map(c => c.label);
      const rows = data.table.rows.map(r => r.c.map(cell => (cell ? cell.v : "")));

      // в объект по заголовкам
      return rows.map(values => {
        const obj = {};
        cols.forEach((k, i) => obj[k] = values[i]);
        return obj;
      });
    }

    function buildPopupHtml(row) {
      const id = row[COL_ID];
      const photos = parsePhotoUrls(row[COL_PHOTO]);

      const title = `<div class="popup-title">Щит ID: ${esc(id)}</div>`;
      const meta = `<div class="popup-meta">Клик по popup или маркеру: добавить/убрать ID</div>`;

      let imgs = "";
      if (photos.length > 0) {
        imgs = photos.slice(0, 6).map(u =>
          `<img class="popup-img" src="${esc(u)}" loading="lazy" referrerpolicy="no-referrer"
                onerror="this.style.display='none';" />`
        ).join("");
      } else {
        imgs = `<div class="popup-meta" style="margin-top:6px;">Фото не указано</div>`;
      }

      return `${title}${meta}${imgs}`;
    }

    async function renderMarkers() {
      markersLayer.clearLayers();

      const rows = await loadSheetRows();

      const bounds = [];

      for (const row of rows) {
        const id = String(row[COL_ID] ?? "").trim();
        const lat = toNumber(row[COL_LAT]);
        const lng = toNumber(row[COL_LNG]);

        if (!id || lat === null || lng === null) continue;

        const marker = L.marker([lat, lng], { title: `ID ${id}` });

        const popupHtml = buildPopupHtml(row);
        marker.bindPopup(popupHtml, { maxWidth: 300 });

        // ✅ ВЫБОР: по клику на маркер — переключаем ID и открываем popup
        marker.on("click", () => {
          toggleId(id);
        });

        // ✅ И по клику внутри popup — тоже переключаем (удобно на мобилке)
        marker.on("popupopen", (e) => {
          const el = e.popup.getElement();
          if (!el) return;
          el.style.cursor = "pointer";
          const handler = () => toggleId(id);
          el.addEventListener("click", handler, { once: false });
        });

        marker.addTo(markersLayer);
        bounds.push([lat, lng]);
      }

      if (bounds.length > 0) map.fitBounds(bounds, { padding: [30, 30] });
    }

    renderMarkers().catch(err => {
      console.error(err);
      alert("Ошибка загрузки карты/таблицы. Проверь: опубликован ли Google Sheet и правильные ли SHEET_ID/SHEET_NAME.");
    });
  </script>
</body>
</html>
