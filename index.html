<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Werbeflächen Karte</title>

  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#fff; }

    @keyframes bbspin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    .wrap { max-width: 1200px; margin: 0 auto; padding: 12px 16px; box-sizing: border-box; }
    #status {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      padding: 10px 12px;
      border: 1px dashed #bbb;
      border-radius: 10px;
      margin: 10px 0;
      background: #fff;
    }

    /* Make map fit viewport without extra scrollbar */
    #map {
      width: 100%;
      height: calc(100vh - 140px); /* header + status + paddings */
      min-height: 420px;
      border-radius: 12px;
      overflow: hidden;
      background: #f3f3f3;
    }

    /* Loading overlay */
    #loading { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; pointer-events: none; z-index: 9999; }
    #loading .box { background: rgba(255,255,255,.96); padding: 18px 22px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.15); text-align: center; }
    #loading .spin { width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #e53935; border-radius: 50%; margin: 0 auto 10px; animation: bbspin 1s linear infinite; }
    #loading .txt { font-size: 14px; color: #666; }

    /* Popup styles */
    .bb-popup { min-width: 240px; max-width: 360px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .bb-title { font-weight: 800; font-size: 16px; margin-bottom: 6px; color: #222; }
    .bb-addr { font-size: 13px; margin-bottom: 8px; color:#333; }
    .bb-details { font-size: 13px; line-height: 1.5; margin-bottom: 10px; }
    .bb-details div { margin: 4px 0; }
    .bb-photo { margin: 10px 0; }
    .bb-photo img { width: 100%; max-width: 340px; height: auto; border-radius: 10px; display: block; background:#fafafa; }
    .bb-nophoto { margin: 10px 0; font-size: 12px; opacity: .75; font-style: italic; }
    .bb-notes { font-size: 12px; margin: 8px 0; opacity: .9; padding: 8px; background: #f5f5f5; border-radius: 6px; }

    /* Button: red bg, white text */
    .bb-btn {
      display: inline-block;
      text-decoration: none;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 800;
      font-size: 13px;
      background: #e53935;
      color: #fff;
      border: none;
      cursor: pointer;
      text-align: center;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .bb-btn:hover { background: #c62828; }

    /* Small hint under status (optional) */
    .muted { color:#666; font-size:12px; }

  </style>
</head>

<body>
  <div class="wrap">
    <div id="status">Karte wird geladen…</div>
    <div id="map"></div>
    <div class="muted" id="hint" style="margin-top:8px; display:none;">
      Hinweis: Falls keine Marker sichtbar sind, prüfen Sie bitte lat/lon und die Veröffentlichung der Tabelle.
    </div>
  </div>

  <div id="loading">
    <div class="box">
      <div class="spin"></div>
      <div class="txt">Werbeflächen werden geladen…</div>
    </div>
  </div>

  <script>
  (function () {
    // ========= CONFIG =========
    const CSV_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTn6jeSv4yw4yKG1SGOklT7LAU2EdWTUj_30jeJK_ZPWfS5wDfcpX96VbFfHms4aQ/pub?output=csv";
    const FORM_URL = "https://webforms.pipedrive.com/f/1sVCSZxh1kw5ffd3drBcGMyEwnWalMUfpd7RjOcvyKkxTh1P6BEZ2XXKidlSR2zYv";

    const CACHE_MINUTES = 15;   // 0 = disable cache
    const DEFAULT_CENTER = [51.0, 10.0];
    const DEFAULT_ZOOM = 6;
    // ==========================

    const statusEl  = document.getElementById("status");
    const loadingEl = document.getElementById("loading");
    const hintEl    = document.getElementById("hint");

    const setStatus = (m) => { statusEl.textContent = m; };
    const showLoading = () => { loadingEl.style.display = "flex"; };
    const hideLoading = () => { loadingEl.style.display = "none"; };

    function loadCSS(url){
      return new Promise((res, rej) => {
        const l = document.createElement("link");
        l.rel = "stylesheet";
        l.href = url;
        l.onload = res;
        l.onerror = () => rej(new Error("CSS konnte nicht geladen werden: " + url));
        document.head.appendChild(l);
      });
    }
    function loadScript(url){
      return new Promise((res, rej) => {
        const s = document.createElement("script");
        s.src = url;
        s.async = true;
        s.onload = res;
        s.onerror = () => rej(new Error("Script konnte nicht geladen werden: " + url));
        document.head.appendChild(s);
      });
    }

    const toNum = (v) => {
      if (v === null || v === undefined) return NaN;
      return Number(String(v).trim().replace(",", "."));
    };

    const esc = (s) => String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");

    function driveToDirectImage(url) {
      const u = String(url || "").trim();
      if (!u) return "";

      // 1) https://drive.google.com/uc?id=FILE -> https://drive.google.com/uc?export=view&id=FILE
      if (u.startsWith("https://drive.google.com/uc?id=")) {
        const fileId = u.split("uc?id=")[1];
        return "https://drive.google.com/uc?export=view&id=" + encodeURIComponent(fileId);
      }

      // 2) https://drive.google.com/file/d/FILE/view -> https://drive.google.com/uc?export=view&id=FILE
      const m = u.match(/drive\.google\.com\/file\/d\/([^/]+)\//);
      if (m && m[1]) {
        return "https://drive.google.com/uc?export=view&id=" + encodeURIComponent(m[1]);
      }

      // already direct or non-drive url
      return u;
    }

    function normalizeRow(row) {
      row = row || {};
      row.id = String(row.id ?? "").trim();

      row.title   = row.title ?? "";
      row.address = row.address ?? "";
      row.lat     = row.lat ?? "";
      row.lon     = row.lon ?? "";
      row.price   = row.price ?? "";
      row.format  = row.format ?? "";
      row.notes   = row.notes ?? "";

      // Leistungswert may come as Leistungswert with capital L
      row.leistungswert = row.leistungswert || row.Leistungswert || row["Leistungswert"] || "";

      // Photo URL key from CSV: photo_url
      row.photo_url = row.photo_url || row["photo_url"] || row.Photo_URL || row.photo || row.photoUrl || "";

      // Make Drive URLs work in <img>
      row.photo_url = driveToDirectImage(row.photo_url);

      return row;
    }

    function buildFormLink(row) {
      // Reliable prefill: pass all info as single "context" param
      const context =
        "ID: " + (row.id || "") + "\n" +
        "Titel: " + (row.title || "") + "\n" +
        "Adresse: " + (row.address || "") + "\n" +
        "Preis: " + (row.price || "") + "\n" +
        "Format: " + (row.format || "") + "\n" +
        "Leistungswert: " + (row.leistungswert || "");

      const params = new URLSearchParams({ context });
      return FORM_URL + (FORM_URL.includes("?") ? "&" : "?") + params.toString();
    }

    function popupHtml(row) {
      const title  = esc(row.title || "");
      const addr   = esc(row.address || "");
      const format = esc(row.format || "");
      const price  = esc(row.price || "");
      const lw     = esc(row.leistungswert || "");
      const notes  = esc(row.notes || "");
      const photo  = String(row.photo_url ?? row["photo_url"] ?? "").trim();
      const btnUrl = buildFormLink(row);

      const photoBlock = photo
        ? `<div class="bb-photo">
             <img src="${esc(photo)}" alt="${title}" loading="lazy" />
           </div>`
        : `<div class="bb-nophoto">Kein Foto verfügbar</div>`;

      return `
        <div class="bb-popup">
          <div class="bb-title">${title || ("ID " + esc(row.id || "?"))}</div>
          ${addr ? `<div class="bb-addr"><b>Adresse:</b> ${addr}</div>` : ""}

          <div class="bb-details">
            ${format ? `<div><b>Format:</b> ${format}</div>` : ""}
            ${price ? `<div><b>Preis:</b> ${price}</div>` : ""}
            ${lw ? `<div><b>Leistungswert:</b> ${lw}</div>` : ""}
            ${row.id ? `<div style="opacity:.7"><b>ID:</b> ${esc(row.id)}</div>` : ""}
          </div>

          ${photoBlock}

          ${notes ? `<div class="bb-notes"><b>Hinweise:</b><br>${notes}</div>` : ""}

          <a href="${esc(btnUrl)}" target="_blank" rel="noopener" class="bb-btn">Angebot anfordern</a>
        </div>
      `;
    }

    // Cache
    function getCachedRows() {
      if (CACHE_MINUTES === 0) return null;
      try {
        const raw = localStorage.getItem("bb_map_cache_v2");
        if (!raw) return null;
        const obj = JSON.parse(raw);
        const ageMin = (Date.now() - obj.ts) / 1000 / 60;
        if (ageMin <= CACHE_MINUTES && Array.isArray(obj.rows)) return obj.rows;
        localStorage.removeItem("bb_map_cache_v2");
      } catch {}
      return null;
    }

    function setCachedRows(rows) {
      if (CACHE_MINUTES === 0) return;
      try {
        localStorage.setItem("bb_map_cache_v2", JSON.stringify({ ts: Date.now(), rows }));
      } catch {}
    }

    // Map position persistence
    function saveMapPos(map) {
      try {
        const c = map.getCenter();
        localStorage.setItem("bb_map_pos_v2", JSON.stringify({ lat: c.lat, lng: c.lng, zoom: map.getZoom() }));
      } catch {}
    }

    function restoreMapPos(map) {
      try {
        const raw = localStorage.getItem("bb_map_pos_v2");
        if (!raw) return false;
        const p = JSON.parse(raw);
        if (!p) return false;
        map.setView([p.lat, p.lng], p.zoom);
        return true;
      } catch {
        return false;
      }
    }

    async function init() {
      setStatus("Karte wird geladen…");
      showLoading();

      // Load libraries
      await loadCSS("https://unpkg.com/leaflet@1.9.4/dist/leaflet.css");
      await loadCSS("https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css");
      await loadCSS("https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css");

      await loadScript("https://unpkg.com/leaflet@1.9.4/dist/leaflet.js");
      await loadScript("https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js");
      await loadScript("https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js");

      if (!window.L) throw new Error("Leaflet ist nicht verfügbar.");
      if (!window.Papa) throw new Error("PapaParse ist nicht verfügbar.");
      if (!L.markerClusterGroup) throw new Error("MarkerCluster ist nicht verfügbar.");

      // Init map
      const map = L.map("map", { scrollWheelZoom: true, zoomControl: true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      const clusters = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
      });
      map.addLayer(clusters);

      map.on("moveend", () => saveMapPos(map));
      restoreMapPos(map);

      const renderRows = (rows) => {
        clusters.clearLayers();

        let added = 0;
        for (const raw of rows) {
          const row = normalizeRow(raw);
          const lat = toNum(row.lat);
          const lon = toNum(row.lon);
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;

          const marker = L.marker([lat, lon]);
          marker.bindPopup(popupHtml(row), { maxWidth: 420 });
          clusters.addLayer(marker);
          added++;
        }

        hideLoading();

        // Status: only count
        setStatus("Werbeflächen: " + added);
        hintEl.style.display = added ? "none" : "block";

        if (added > 0) {
          map.fitBounds(clusters.getBounds().pad(0.15));
        }
      };

      // Cache first
      const cached = getCachedRows();
      if (cached) {
        renderRows(cached);
        return;
      }

      // Load CSV
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (r) => {
          const rows = r.data || [];
          setCachedRows(rows);
          renderRows(rows);
        },
        error: () => {
          hideLoading();
          setStatus("Fehler: Daten konnten nicht geladen werden.");
          hintEl.style.display = "block";
        }
      });
    }

    init().catch(err => {
      hideLoading();
      setStatus("Fehler: " + err.message);
      hintEl.style.display = "block";
      console.error(err);
    });
  })();
  </script>
</body>
</html>
